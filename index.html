<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è­·çœ¼å¾…æ©Ÿé˜</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #f4f1de; 
            --alert-bg: #f4f1de;
            --alert-text: #000000;
            --ui-opacity: 0.3;
            --ui-opacity-hover: 1;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace, sans-serif;
            margin: 0; height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            transition: background-color 0.5s, color 0.5s;
            cursor: pointer; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- æ™‚é˜ --- */
        #clock-wrapper {
            display: flex; align-items: center; justify-content: center;
            width: 100%; height: 100%;
            font-size: min(32vw, 55vh); 
            line-height: 1; font-weight: bold; letter-spacing: -0.05em;
        }
        .colon {
            margin: 0 0.05em; position: relative; top: -0.05em;
            animation: blink 1s steps(1) infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }

        /* --- è­¦ç¤ºå‘¼å¸ --- */
        @keyframes slow-breath {
            0%, 100% { background-color: var(--bg-color); color: var(--text-color); }
            50% { background-color: var(--alert-bg); color: var(--alert-text); }
        }
        body.alert-mode { animation: slow-breath 4s infinite ease-in-out; }

        /* --- è¨Šæ¯å±¤ --- */
        #message-area {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; z-index: 10;
        }
        #action-title { font-size: min(10vw, 8vh); font-weight: bold; margin-bottom: 5vh; }
        #action-desc { font-size: min(5vw, 4vh); opacity: 0.8; line-height: 1.5; padding: 0 20px;}
        #countdown-number { font-size: min(30vw, 40vh); font-weight: bold; }

        .hidden { display: none !important; }
        
        /* --- ğŸ èŸ²èŸ²æ¨£å¼ --- */
        .bug {
            position: absolute;
            width: 40px; height: 40px;
            font-size: 30px;
            display: flex; justify-content: center; align-items: center;
            cursor: crosshair;
            z-index: 50;
            transition: transform 3s linear; /* ç§»å‹•å‹•ç•« */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        /* å£“æ‰å‹•ç•« */
        .bug.squashed {
            transform: scale(1.2, 0.2) !important; /* è®Šæ‰ */
            opacity: 0;
            transition: transform 0.1s, opacity 0.5s;
            pointer-events: none;
        }

        /* --- UI æ§åˆ¶é … --- */
        .control-btn {
            position: fixed; z-index: 100;
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(4px);
            border-radius: 50%; width: 44px; height: 44px;
            display: flex; justify-content: center; align-items: center;
            opacity: var(--ui-opacity); transition: all 0.3s ease; color: var(--text-color);
        }
        .control-btn:hover, .control-btn.active { opacity: var(--ui-opacity-hover); background: rgba(255, 255, 255, 0.25); }
        .control-btn svg { width: 20px; height: 20px; fill: currentColor; }

        #btn-test { top: 20px; right: 20px; }
        #btn-palette { top: 20px; left: 20px; }
        #btn-sound { bottom: 20px; right: 20px; } /* æ–°å¢éŸ³æ•ˆé–‹é—œ */

        /* é¡è‰²é¸å–® */
        #color-menu {
            position: fixed; top: 20px; left: 74px; display: flex; gap: 10px;
            background: rgba(50, 50, 50, 0.8); padding: 8px 12px; border-radius: 30px; z-index: 99;
            transform: translateX(-20px); opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #color-menu.expanded { transform: translateX(0); opacity: 1; pointer-events: auto; }
        .color-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; }
        .color-dot:active { transform: scale(0.8); }

    </style>
</head>
<body>

    <div id="clock-wrapper">
        <span id="hour">00</span><span class="colon">:</span><span id="minute">00</span>
    </div>

    <div id="message-area">
        <div id="action-title"></div>
        <div id="countdown-number" class="hidden"></div>
        <div id="action-desc"></div>
    </div>

    <div id="btn-palette" class="control-btn" onclick="event.stopPropagation(); toggleColorMenu()">
        <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
    </div>

    <div id="color-menu">
        <div class="color-dot" style="background: #f4f1de;" onclick="setColor('#f4f1de')"></div>
        <div class="color-dot" style="background: #ffb703;" onclick="setColor('#ffb703')"></div>
        <div class="color-dot" style="background: #55efc4;" onclick="setColor('#55efc4')"></div>
        <div class="color-dot" style="background: #b2bec3;" onclick="setColor('#b2bec3')"></div>
        <div class="color-dot" style="background: #ff7675;" onclick="setColor('#ff7675')"></div>
    </div>

    <div id="btn-test" class="control-btn" onclick="event.stopPropagation(); triggerAlert()">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </div>

    <div id="btn-sound" class="control-btn" onclick="event.stopPropagation(); toggleSound()">
        <svg id="icon-sound-off" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
        <svg id="icon-sound-on" class="hidden" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
    </div>

    <script>
        // --- è¨­å®š ---
        const WORK_INTERVAL = 20 * 60 * 1000; 
        const BUG_INTERVAL_MIN = 1 * 60 * 1000; // èŸ²èŸ²æœ€å¿«1åˆ†é˜å‡ºä¸€æ¬¡
        const BUG_INTERVAL_MAX = 5 * 60 * 1000; // æœ€æ…¢5åˆ†é˜å‡ºä¸€æ¬¡

        const EXERCISES = [
            { title: "é çœºæ”¾é¬†", desc: "çœ‹å‘é æ–¹ï¼Œæ”¾ç©ºçœ¼ç¥", duration: 20 },
            { title: "ç”¨åŠ›çœ¨çœ¼", desc: "ç”¨åŠ›é–‰çœ¼å†å¼µé–‹ï¼Œé‡è¤‡å‹•ä½œ", duration: 10 },
            { title: "çœ¼çƒè½‰å‹•", desc: "é †æ™‚é‡è½‰ä¸‰åœˆï¼Œé€†æ™‚é‡è½‰ä¸‰åœˆ", duration: 15 },
            { title: "æŒå¿ƒç†±æ•·", desc: "é›™æ‰‹æ“ç†±ï¼Œè¼•è“‹çœ¼çš®", duration: 30 }
        ];

        const State = { CLOCK: 'CLOCK', ALERT: 'ALERT', INSTRUCT: 'INSTRUCT', GUIDE: 'GUIDE' };
        let currentState = State.CLOCK;
        let workTimer = null;
        let guideTimer = null;
        let bugTimer = null;
        let isSoundOn = false; // é è¨­éœéŸ³ (ç€è¦½å™¨æ”¿ç­–é™åˆ¶è‡ªå‹•æ’­éŸ³)

        // DOM
        const elBody = document.body;
        const elClockWrapper = document.getElementById('clock-wrapper');
        const elMsgArea = document.getElementById('message-area');
        const elTitle = document.getElementById('action-title');
        const elDesc = document.getElementById('action-desc');
        const elCount = document.getElementById('countdown-number');
        const elColorMenu = document.getElementById('color-menu');
        const elPaletteBtn = document.getElementById('btn-palette');
        const elSoundBtn = document.getElementById('btn-sound');

        // éŸ³æ•ˆ Context
        let audioCtx = null;

        // --- 1. æ ¸å¿ƒé‚è¼¯ ---
        function startApp() {
            updateClock();
            setInterval(updateClock, 1000);
            resetWorkTimer();
            scheduleNextBug(); // å•Ÿå‹•èŸ²èŸ²æ’ç¨‹
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('hour').innerText = String(now.getHours()).padStart(2, '0');
            document.getElementById('minute').innerText = String(now.getMinutes()).padStart(2, '0');
        }

        function resetWorkTimer() {
            if (workTimer) clearTimeout(workTimer);
            workTimer = setTimeout(triggerAlert, WORK_INTERVAL);
        }

        // --- 2. ğŸ èŸ²èŸ²é‚è¼¯ ---
        function scheduleNextBug() {
            if (bugTimer) clearTimeout(bugTimer);
            // éš¨æ©Ÿæ™‚é–“ç”Ÿæˆ
            const delay = Math.random() * (BUG_INTERVAL_MAX - BUG_INTERVAL_MIN) + BUG_INTERVAL_MIN;
            // é–‹ç™¼æ¸¬è©¦ï¼šæ¯ 10-20 ç§’å‡ºä¸€éš»
            // const delay = Math.random() * 10000 + 10000; 
            
            bugTimer = setTimeout(() => {
                if (currentState === State.CLOCK) spawnBug();
                scheduleNextBug(); // éè¿´æ’ç¨‹
            }, delay);
        }

        function spawnBug() {
            const bug = document.createElement('div');
            bug.className = 'bug';
            bug.innerText = 'ğŸ'; // ä¹Ÿå¯ä»¥æ›æˆç°¡å–®çš„é»‘è‰²åœ“é»: bug.style.background = 'var(--text-color)'; bug.style.borderRadius='50%';
            
            // éš¨æ©Ÿèµ·é» (è¢å¹•é‚Šç·£)
            const side = Math.floor(Math.random() * 4); // 0:ä¸Š, 1:å³, 2:ä¸‹, 3:å·¦
            let startX, startY, endX, endY;
            const padding = 50;

            if(side === 0) { startX = Math.random()*window.innerWidth; startY = -padding; endY = window.innerHeight + padding; endX = Math.random()*window.innerWidth; }
            else if(side === 1) { startX = window.innerWidth + padding; startY = Math.random()*window.innerHeight; endX = -padding; endY = Math.random()*window.innerHeight; }
            else if(side === 2) { startX = Math.random()*window.innerWidth; startY = window.innerHeight + padding; endY = -padding; endX = Math.random()*window.innerWidth; }
            else { startX = -padding; startY = Math.random()*window.innerHeight; endX = window.innerWidth + padding; endY = Math.random()*window.innerHeight; }

            bug.style.left = startX + 'px';
            bug.style.top = startY + 'px';
            document.body.appendChild(bug);

            // è§¸ç™¼ç§»å‹• (setTimeout è®“ DOM æœ‰æ™‚é–“ render)
            setTimeout(() => {
                bug.style.transform = `translate(${endX - startX}px, ${endY - startY}px)`;
            }, 50);

            // é»æ“Šäº‹ä»¶ (å£“æ‰)
            bug.addEventListener('touchstart', squashBug); // æ‰‹æ©Ÿå„ªå…ˆ
            bug.addEventListener('mousedown', squashBug);

            // 5ç§’å¾Œè‹¥æ²’äººç†å®ƒï¼Œç§»é™¤ DOM
            setTimeout(() => { if(bug.parentElement) bug.remove(); }, 5000);
        }

        function squashBug(e) {
            e.stopPropagation(); // ä¸è¦è§¸ç™¼æ™‚é˜çš„é»æ“Š
            const bug = e.target;
            if (bug.classList.contains('squashed')) return;

            bug.classList.add('squashed');
            pulseVibrate(50); // çŸ­éœ‡å‹•
            playSound(600, 0.1, 'square'); // çŸ­éŸ³æ•ˆ
            
            // 0.5ç§’å¾Œç§»é™¤
            setTimeout(() => bug.remove(), 500);
        }

        // --- 3. éœ‡å‹•èˆ‡éŸ³æ•ˆ (Haptics & Audio) ---
        
        // éœ‡å‹•å°è£ (Android only)
        function pulseVibrate(pattern) {
            if ('vibrate' in navigator) navigator.vibrate(pattern);
        }

        // éŸ³æ•ˆå°è£ (Web Audio API) - ç”¨ç¨‹å¼ç¢¼ç”¢ç”Ÿè²éŸ³ï¼Œä¸ç”¨ä¸‹è¼‰æª”æ¡ˆ
        function playSound(freq, duration, type = 'sine') {
            if (!isSoundOn) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        window.toggleSound = function() {
            isSoundOn = !isSoundOn;
            document.getElementById('icon-sound-off').classList.toggle('hidden', isSoundOn);
            document.getElementById('icon-sound-on').classList.toggle('hidden', !isSoundOn);
            
            // é¦–æ¬¡é–‹å•Ÿæ™‚åˆå§‹åŒ– AudioContext (iOS éœ€è¦ä½¿ç”¨è€…äº’å‹•æ‰èƒ½æ’­éŸ³)
            if (isSoundOn && !audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                playSound(440, 0.1); // æ’­æ”¾ä¸€å€‹æ¸¬è©¦éŸ³
            }
        }

        // --- 4. è­¦å ±èˆ‡æµç¨‹ ---
        window.triggerAlert = function() {
            if (currentState !== State.CLOCK) return;
            currentState = State.ALERT;
            elBody.classList.add('alert-mode');
            
            // éš±è— UI
            elPaletteBtn.classList.add('hidden');
            document.getElementById('btn-test').classList.add('hidden');
            elSoundBtn.classList.add('hidden');
            
            // æé†’ï¼šé•·éœ‡å‹• + è²éŸ³
            pulseVibrate([500, 200, 500]); 
            playSound(300, 1); // æ¯”è¼ƒé•·çš„æç¤ºéŸ³
        }

        document.body.addEventListener('click', (e) => {
            if (e.target.closest('.control-btn') || e.target.closest('#color-menu') || e.target.closest('.bug')) return;
            handleInteraction();
        });

        function handleInteraction() {
            switch (currentState) {
                case State.CLOCK: break;
                case State.ALERT: showInstruction(); break;
                case State.INSTRUCT: startGuiding(); break;
                case State.GUIDE: finishExercise(); break;
            }
        }

        function showInstruction() {
            currentState = State.INSTRUCT;
            elBody.classList.remove('alert-mode');
            
            const ex = EXERCISES[Math.floor(Math.random() * EXERCISES.length)];
            window.currentEx = ex;

            elClockWrapper.classList.add('hidden');
            elMsgArea.style.display = 'flex';
            elTitle.innerText = ex.title;
            elDesc.innerText = ex.desc + "\n\n(å†æ¬¡é»æ“Šé–‹å§‹è¨ˆæ™‚)";
            elDesc.classList.remove('hidden');
            elCount.classList.add('hidden');
        }

        function startGuiding() {
            currentState = State.GUIDE;
            elDesc.classList.add('hidden');
            elCount.classList.remove('hidden');
            elCount.innerText = window.currentEx.duration;
            
            let timeLeft = window.currentEx.duration;
            guideTimer = setInterval(() => {
                timeLeft--;
                elCount.innerText = timeLeft;
                if (timeLeft <= 0) finishExercise();
            }, 1000);
        }

        function finishExercise() {
            if (guideTimer) clearInterval(guideTimer);
            currentState = State.CLOCK;
            
            // å®Œæˆæç¤ºï¼šé›™éœ‡å‹• + è¼•å¿«éŸ³æ•ˆ
            pulseVibrate([200, 100, 200]);
            playSound(880, 0.2); 
            setTimeout(() => playSound(1100, 0.4), 200);

            elTitle.innerText = "å®Œæˆä¼‘æ¯";
            elCount.classList.add('hidden');
            
            setTimeout(() => {
                elMsgArea.style.display = 'none';
                elClockWrapper.classList.remove('hidden');
                
                elPaletteBtn.classList.remove('hidden');
                document.getElementById('btn-test').classList.remove('hidden');
                elSoundBtn.classList.remove('hidden');
                
                resetWorkTimer();
            }, 1500);
        }

        // 5. é¡è‰²/UI å…¶ä»–é‚è¼¯
        window.toggleColorMenu = function() {
            elColorMenu.classList.toggle('expanded');
            elPaletteBtn.classList.toggle('active');
        }
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#btn-palette') && !e.target.closest('#color-menu')) {
                elColorMenu.classList.remove('expanded');
                elPaletteBtn.classList.remove('active');
            }
        });
        window.setColor = function(color) {
            document.documentElement.style.setProperty('--text-color', color);
            document.documentElement.style.setProperty('--alert-bg', color);
            elColorMenu.classList.remove('expanded');
        }

        startApp();
    </script>
</body>
</html>
